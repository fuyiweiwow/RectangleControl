<UserControl x:Class="Test25D.Views.MarkRectangleControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Test25D.Views"
             xmlns:vm="clr-namespace:RectangleControl.ViewModels"
             xmlns:slc="clr-namespace:RectangleControl.Selectors"
             xmlns:cvt="clr-namespace:RectangleControl.Converters"
             xmlns:b ="http://schemas.microsoft.com/xaml/behaviors"
             mc:Ignorable="d" 
             d:DataContext="{d:DesignInstance vm:MarkRectangleViewModel}"
             d:DesignHeight="450" d:DesignWidth="800">
    <UserControl.Resources>

        <Style x:Key="RedCircleThumbStyle" TargetType="Thumb">
            <Setter Property="Width" Value="16"/>
            <Setter Property="Height" Value="16"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Thumb">
                        <Ellipse 
                            x:Name="ellipse"
                            Fill="Red"
                            Stroke="DarkRed"
                            StrokeThickness="1"
                            Width="{TemplateBinding Width}"
                            Height="{TemplateBinding Height}">
                            <Ellipse.Effect>
                                <DropShadowEffect BlurRadius="3" Opacity="0.5" />
                            </Ellipse.Effect>
                        </Ellipse>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsDragging" Value="True">
                                <Setter Property="Fill" TargetName="ellipse" Value="DarkRed" />
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect BlurRadius="5" Opacity="0.8" />
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="RotateFigureThumbStyle" TargetType="Thumb">
            <Setter Property="Width" Value="16"/>
            <Setter Property="Height" Value="16"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Thumb">
                        <Ellipse
                            x:Name="ellipse"
                            Width="{TemplateBinding Width}"
                            Height="{TemplateBinding Height}">
                            <Ellipse.Fill>
                                <DrawingBrush>
                                    <DrawingBrush.Drawing>
                                        <GeometryDrawing Brush="{Binding Background,RelativeSource={RelativeSource AncestorType=Thumb, Mode=FindAncestor}}">
                                            <GeometryDrawing.Geometry>
                                                <PathGeometry 
                                                    Figures="M35.072 512h121.446v-10.496c5.53-227.021
                                                    190.669-409.395 418.253-409.395 231.168 0 418.509 
                                                    188.006 418.509 419.891s-187.341 419.789-418.509 
                                                    419.789c-97.178 0-186.624-33.28-257.69-88.986l71.987-77.005c52.019 
                                                    38.298 116.224 61.082 185.702 61.082 173.363 0 313.907-141.005
                                                    313.907-314.88s-140.544-314.88-313.907-314.88c-169.83 0-308.122 
                                                    135.322-313.6 304.384v10.496h136.806l-178.893 199.373-184.013-199.373z"/>
                                            </GeometryDrawing.Geometry>
                                        </GeometryDrawing>
                                    </DrawingBrush.Drawing>
                                </DrawingBrush>
                            </Ellipse.Fill>
                        </Ellipse>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsDragging" Value="True">
                                <Setter Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect BlurRadius="5" Opacity="0.8" />
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect BlurRadius="5" Opacity="0.8" />
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>


        <DataTemplate x:Key="ResizeMarkTemplate" DataType="vm:ResizeMarkThumbViewModel">
            <Thumb
                Style="{StaticResource RedCircleThumbStyle}"
                Width="{Binding Width}"
                Height="{Binding Width}">
                <b:Interaction.Triggers>
                    <b:EventTrigger EventName="DragStarted">
                        <b:InvokeCommandAction 
                            Command="{Binding DragStartedCommand}" 
                            EventArgsConverter="{cvt:DragArgsConverter}"
                            PassEventArgsToCommand="True"/>
                    </b:EventTrigger>
                    <b:EventTrigger EventName="DragDelta">
                        <b:InvokeCommandAction 
                            Command="{Binding DragDeltaCommand}" 
                            EventArgsConverter="{cvt:DragArgsConverter}"
                            PassEventArgsToCommand="True"/>
                    </b:EventTrigger>
                    <b:EventTrigger EventName="DragCompleted">
                        <b:InvokeCommandAction 
                            Command="{Binding DragCompletedCommand}" 
                            PassEventArgsToCommand="True"/>
                    </b:EventTrigger>
                </b:Interaction.Triggers>
            </Thumb>
        </DataTemplate>

        <DataTemplate x:Key="RotateHandleTemplate" DataType="vm:RotateHandle">
            <Line
                Stroke="Chocolate"
                StrokeThickness="2"
                X1="{Binding Start.X}"
                Y1="{Binding Start.Y}"
                X2="{Binding End.X}"
                Y2="{Binding End.Y}"
                IsHitTestVisible="False"
                RenderTransformOrigin="0.5, 0.5"/>
        </DataTemplate>

        <DataTemplate x:Key="RotateMarkTemplate" DataType="vm:RotateMarkViewModel">
            <Thumb
                Style="{StaticResource RotateFigureThumbStyle}"
                Width="{Binding Width}"
                Height="{Binding Width}"
                Background="Chocolate"
                RenderTransformOrigin="0.5, 0.5">
                <Thumb.RenderTransform>
                    <RotateTransform Angle="{Binding Angle}"/>
                </Thumb.RenderTransform>
                <b:Interaction.Triggers>
                    <b:EventTrigger EventName="DragStarted">
                        <b:InvokeCommandAction 
                            Command="{Binding DragStartedCommand}" 
                            EventArgsConverter="{cvt:DragArgsConverter}"
                            PassEventArgsToCommand="True"/>
                    </b:EventTrigger>
                    <b:EventTrigger EventName="DragDelta">
                        <b:InvokeCommandAction 
                            Command="{Binding DragDeltaCommand}" 
                            EventArgsConverter="{cvt:DragArgsConverter}"
                            PassEventArgsToCommand="True"/>
                    </b:EventTrigger>
                    <b:EventTrigger EventName="DragCompleted">
                        <b:InvokeCommandAction 
                            Command="{Binding DragCompletedCommand}" 
                            PassEventArgsToCommand="True"/>
                    </b:EventTrigger>
                </b:Interaction.Triggers>
            </Thumb>
        </DataTemplate>


        <Style x:Key="MarkThumbStyle" TargetType="ContentPresenter">
            <Setter Property="Canvas.Left">
                <Setter.Value>
                    <MultiBinding Converter="{cvt:MarkThumbPositionConverter}">
                        <Binding Path="Position.X"/>
                        <Binding Path="Offset"/>
                    </MultiBinding>
                </Setter.Value>
            </Setter>
            <Setter Property="Canvas.Top">
                <Setter.Value>
                    <MultiBinding Converter="{cvt:MarkThumbPositionConverter}">
                        <Binding Path="Position.Y"/>
                        <Binding Path="Offset"/>
                    </MultiBinding>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="RotateHandleStyle" TargetType="ContentPresenter">
            <Setter Property="Canvas.Left" Value="0"/>
            <Setter Property="Canvas.Top" Value="0"/>
        </Style>

    </UserControl.Resources>
    <Grid>
        <Rectangle
             x:Name="Part_Rect"
             Width="{Binding Width}"
             Height="{Binding Height}"
             Fill="Transparent"
             Stroke="LightPink"
             StrokeThickness="2"
             IsHitTestVisible="False"
             RenderTransformOrigin="0, 0">
            <Rectangle.RenderTransform>
                <MatrixTransform Matrix="{Binding Matrix}"/>
            </Rectangle.RenderTransform>
        </Rectangle>

        <ItemsControl 
            ItemsSource="{Binding Marks}">
            <ItemsControl.ItemTemplateSelector>
                <sel:RectangleMarkTemplateSelector 
                    ResizeTemplate="{StaticResource ResizeMarkTemplate}"
                    RotateTemplate="{StaticResource RotateMarkTemplate}"
                    RotateHandleTemplate="{StaticResource RotateHandleTemplate}"/>
            </ItemsControl.ItemTemplateSelector>
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <Canvas/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemContainerStyleSelector>
                <sel:RectangleMarkStyleSelector
                    MarkStyle="{StaticResource MarkThumbStyle}"
                    RotateHandleStyle="{StaticResource RotateHandleStyle}"/>
            </ItemsControl.ItemContainerStyleSelector>
        </ItemsControl>
    </Grid>
   
</UserControl>
